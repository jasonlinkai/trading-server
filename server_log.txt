
> trading-server@1.0.0 dev
> ts-node-dev --respawn src/index.ts

[INFO] 18:02:07 ts-node-dev ver. 2.0.0 (using ts-node ver. 10.9.2, typescript ver. 5.8.2)

[TradingServiceFactory][CREATE] ========== 開始創建交易服務 ==========
[TradingServiceFactory][CREATE] 請求創建交易服務，參數:
  - 交易所類型: bitmex
  - API密鑰狀態: 已提供 (長度: 24)
  - API密碼狀態: 已提供 (長度: 48)
  - 測試網模式: true
[TradingServiceFactory][CREATE] 根據交易所類型創建具體服務實例...
[TradingServiceFactory][CREATE] 創建 BitMEX 交易服務實例
[BitMEXService][INIT] 初始化 BitMEX 服務 (API Key: 已設置, Testnet: 啟用) - 為交易準備基礎服務
[TradingService][INIT] 初始化交易服務, 交易所: bitmex, 測試網: true
[TradingService][AUTH] API密鑰狀態: 已提供, 密鑰狀態: 已提供
[TradingService][INIT] 創建 bitmex 交易所實例
[TradingService][INIT] 配置測試網模式，交易所: bitmex
[TradingService][INIT] 測試網 URL: [object Object]
[TradingService][INIT] 交易服務初始化完成, 交易所: bitmex, 基礎URL: [object Object]
[BitMEXService][INIT] 初始化交易對符號映射關係 - 用於處理不同系統間的符號格式差異
[BitMEXService][INIT] 符號映射關係初始化完成: 9 個映射 - 確保交易符號兼容性
[BitMEXService][INIT] 初始化硬編碼的交易對信息 - 作為 API 數據失敗時的備用數據源
[BitMEXService][INIT] 硬編碼交易對信息已更新，包含 9 個交易對 - 確保系統在 API 失敗時仍能正常運作
[BitMEXService][INIT] 設置 BitMEX 測試網模式 - 避免在生產環境意外下單
[BitMEXService][INIT] BitMEX 服務初始化完成，交易所基礎 URL: [object Object] - 已建立交易所連接
[TradingServiceFactory][CREATE] 交易服務創建成功: bitmex
[TradingServiceFactory][CREATE] ========== 交易服務創建完成 ==========

Server is running on port 3000

[請求信息] API 請求詳情：
請求時間：2025-05-01T10:02:33.549Z
請求方法：POST
請求路徑：/
Content-Type：application/json
請求參數：
{
  "symbol": "BTC/USD",
  "action": "sell",
  "qty": 100,
  "price": 35000,
  "take_profit": {
    "points": 500,
    "is_percentage": false
  },
  "stop_loss": {
    "points": 300,
    "is_percentage": false
  }
}


[訂單處理] 開始處理訂單...
[訂單參數]
交易所：undefined
時間週期：undefined
信號時間：undefined
交易對：BTC/USD
操作：SELL
數量：100
當前價格：35000
止盈設置：500 點
止損設置：300 點


========== [BitMEXService][ORDER] 開始處理訂單 ==========
[BitMEXService][ORDER] 訂單詳情: 交易對=BTC/USD, 操作=sell, 數量=100手 - 準備執行交易請求
[BitMEXService][AUTH] 驗證API密鑰可用性: 已設置 - 確保具備交易權限
[BitMEXService][SYMBOL] 開始轉換交易對: BTC/USD - 轉換為交易所接受的格式
[BitMEXService][SYMBOL] 開始轉換交易對: BTC/USD - 原因: 需要將通用符號轉換為 BitMEX 專用格式
[BitMEXService][SYMBOL] 從映射表查找到交易對: BTC/USD -> XBTUSD - 使用預定義映射關係
[BitMEXService][SYMBOL] 交易對轉換完成: BTC/USD => XBTUSD
[BitMEXService][INIT] 初始化交易對 XBTUSD - 獲取最新的市場數據和最小變動單位
[BitMEXService][SYMBOL] 開始轉換交易對: XBTUSD - 原因: 需要將通用符號轉換為 BitMEX 專用格式
[BitMEXService][SYMBOL] 從映射表查找到交易對: XBTUSD -> XBTUSD - 使用預定義映射關係
[BitMEXService][INIT] 初始化交易對 XBTUSD -> XBTUSD - 獲取該交易對的市場數據和最小變動單位
[BitMEXService][API] 從 API 獲取市場數據 - 原因: 快取已過期或不存在，需要最新數據
[BitMEXService][API] 成功獲取 197 個市場數據 - 已更新所有可交易對的最新信息
[BitMEXService][MATCH] 查找 XBTUSD (原始: XBTUSD) 的市場數據 - 比對API返回的市場數據，尋找最佳匹配
[BitMEXService][SYMBOL] 開始轉換交易對: XBTUSD - 原因: 需要將通用符號轉換為 BitMEX 專用格式
[BitMEXService][SYMBOL] 從映射表查找到交易對: XBTUSD -> XBTUSD - 使用預定義映射關係
[BitMEXService][SYMBOL] 開始轉換交易對: XRP/USDT:USDT - 原因: 需要將通用符號轉換為 BitMEX 專用格式
[BitMEXService][SYMBOL] 交易對轉換結果: XRP/USDT:USDT -> XRP/USDT:USDT - 未找到特定映射，可能使用原始符號
[BitMEXService][SYMBOL] 開始轉換交易對: XBTUSD - 原因: 需要將通用符號轉換為 BitMEX 專用格式
[BitMEXService][SYMBOL] 從映射表查找到交易對: XBTUSD -> XBTUSD - 使用預定義映射關係
[BitMEXService][SYMBOL] 開始轉換交易對: SOL/USD:BTC - 原因: 需要將通用符號轉換為 BitMEX 專用格式
[BitMEXService][SYMBOL] 交易對轉換結果: SOL/USD:BTC -> SOL/USD:BTC - 未找到特定映射，可能使用原始符號
[BitMEXService][MATCH] 找到匹配的市場: SOL/USD:BTC (ID: SOLUSD) - 可直接使用此市場數據
[BitMEXService][EXTRACT] 從市場 SOL/USD:BTC 提取 XBTUSD 的 mintick 值 - 分析API返回的市場數據結構
[BitMEXService][EXTRACT] 成功從 tickSize 獲取到 mintick: 0.01 - 直接使用API提供的精確值
[BitMEXService][SET] 為 XBTUSD 設置 mintick: 0.01 - 確保所有相關格式的交易對都使用相同的最小變動單位
[BitMEXService][SET] XBTUSD 的 mintick 設置完成 - 所有相關交易對格式均已更新
[BitMEXService][SYMBOL] 開始轉換交易對: XBTUSD - 原因: 需要將通用符號轉換為 BitMEX 專用格式
[BitMEXService][SYMBOL] 從映射表查找到交易對: XBTUSD -> XBTUSD - 使用預定義映射關係
[BitMEXService][MINTICK] 獲取 XBTUSD 的最小變動單位 - 轉換為 XBTUSD 查詢
[TradingService][MINTICK] 獲取 XBTUSD 的 mintick 值
[TradingService][MINTICK] 返回 XBTUSD 的 mintick 值: 0.01
[BitMEXService][MINTICK] XBTUSD 的最小價格變動單位為: 0.01 - 用於價格計算和四捨五入
[BitMEXService][QTY] 開始轉換交易量: 100手 - 從平台通用單位轉換為交易所特定單位
[TradingService][LOTS] 開始轉換手數: 100 手 -> BTC/USD 交易單位
[TradingService][LOTS] 轉換參數: 手數=100, 交易對=BTC/USD, 價格=35000, 交易所=bitmex
[LotSizeConverter][CONVERT] 開始轉換手數: 100 手 -> BTC/USD 單位, 交易所: bitmex
[LotSizeConverter][CONVERT] 獲取標準 Binance 合約規格...
[LotSizeConverter][GET] 獲取 BTC/USD 在 binance 的合約規格
[LotSizeConverter][GET] BTC/USD 在 binance 的合約規格: 0.001 (默認值)
[LotSizeConverter][CONVERT] 標準合約大小 (Binance): 0.001
[LotSizeConverter][CONVERT] 計算標準幣數量: 100 手 × 0.001 = 0.1 BTC
[LotSizeConverter][CONVERT] BitMEX 交易量計算過程:
  - 幣數量: 0.1 BTC
  - 當前價格: 35000 USD
  - 計算: 0.1 × 35000 = 3500 USD (未四捨五入)
  - 轉換結果: 3500 合約 (四捨五入後)
[LotSizeConverter][CONVERT] 最終 BitMEX 合約數量: 3500
[LotSizeConverter][CONVERT] 手數轉換完成: 100 手 => 3500 單位 (bitmex, BTC/USD)
[TradingService][LOTS] 手數轉換結果: 100 手 = 3500 交易單位
[BitMEXService][QTY] 交易量轉換結果: 100手 => 3500合約 - 適用於XBTUSD的實際合約數量
[BitMEXService][MAIN] 創建market單: sell 3500 XBTUSD  - 提交主要交易訂單
[BitMEXService][MAIN] 主訂單創建成功: ID=7f0cbb93-7215-47b2-8c2d-45a1ee2af362, 狀態=closed - 交易所已接受訂單
[BitMEXService][PRICE] 使用入場價格: 35000 計算止盈止損 - 基準價格用於計算觸發價格
[BitMEXService][TP] 計算止盈價格: 點數=500, 模式=點數
[BitMEXService][CALC] 開始計算止盈價格 - 入場價: 35000, 點數: 500, 模式: 點數, Mintick: 0.01
[BitMEXService][CALC] 點數模式計算 - 調整值: 5 (500 × 0.01) - 根據點數和最小變動單位計算價格差
[BitMEXService][CALC] 價格計算結果: 35000 => 35005 - 按 mintick=0.01 四捨五入，確保價格符合交易所要求
[BitMEXService][SL] 計算止損價格: 點數=300, 模式=點數
[BitMEXService][CALC] 開始計算止損價格 - 入場價: 35000, 點數: 300, 模式: 點數, Mintick: 0.01
[BitMEXService][CALC] 點數模式計算 - 調整值: 3 (300 × 0.01) - 根據點數和最小變動單位計算價格差
[BitMEXService][CALC] 價格計算結果: 35000 => 34997 - 按 mintick=0.01 四捨五入，確保價格符合交易所要求
[BitMEXService][INFO] 使用實際執行數量 3500 創建止盈止損訂單 - 確保數量一致性
[BitMEXService][TP] 創建止盈訂單: buy 3500 XBTUSD @ 35005 - 為實現利潤目標
[BitMEXService][TP] 止盈訂單創建成功: ID=75b012bd-1a91-40ab-b6cb-c5ccf3685e35, 狀態=open - 等待價格達到 35005 觸發
[BitMEXService][SL] 創建止損訂單: buy 3500 XBTUSD @ 34997 - 為控制潛在損失
[BitMEXService][SL] 止損訂單創建成功: ID=eca7c59e-3161-4c05-bd6a-e49bea0dea72, 狀態=closed - 等待價格達到 34997 觸發
[BitMEXService][SUCCESS] 訂單處理完成:
      - 主訂單: 成功
      - 止盈訂單: 成功
      - 止損訂單: 成功
========== [BitMEXService][ORDER] 訂單處理完成 ==========


[訂單成功] 主訂單已成功創建
[訂單詳情] 主訂單信息：
{
  "id": "7f0cbb93-7215-47b2-8c2d-45a1ee2af362",
  "timestamp": 1746093757849,
  "datetime": "2025-05-01T10:02:37.849Z",
  "lastTradeTimestamp": 1746093757848,
  "symbol": "BTC/USD:BTC",
  "type": "market",
  "timeInForce": "IOC",
  "postOnly": false,
  "side": "sell",
  "price": 94781.3394,
  "amount": 0.03692710001943695,
  "cost": 3500,
  "average": 94781.3394,
  "filled": 0.03692710001943695,
  "remaining": 0,
  "status": "closed",
  "trades": [],
  "fees": []
}

[止盈訂單] 止盈訂單信息：
{
  "id": "75b012bd-1a91-40ab-b6cb-c5ccf3685e35",
  "timestamp": 1746093758228,
  "datetime": "2025-05-01T10:02:38.228Z",
  "lastTradeTimestamp": 1746093758228,
  "symbol": "BTC/USD:BTC",
  "type": "marketiftouched",
  "timeInForce": "IOC",
  "postOnly": false,
  "side": "buy",
  "triggerPrice": 35005,
  "cost": 3500,
  "remaining": 3500,
  "status": "open",
  "trades": [],
  "fees": [],
  "stopPrice": 35005
}

[止損訂單] 止損訂單信息：
{
  "id": "eca7c59e-3161-4c05-bd6a-e49bea0dea72",
  "timestamp": 1746093758615,
  "datetime": "2025-05-01T10:02:38.615Z",
  "lastTradeTimestamp": 1746093758613,
  "symbol": "BTC/USD:BTC",
  "type": "stop",
  "timeInForce": "IOC",
  "postOnly": false,
  "side": "buy",
  "triggerPrice": 34997,
  "amount": 0.03684206648203528,
  "cost": 3500,
  "average": 95000.1,
  "filled": 0.03684206648203528,
  "remaining": 0,
  "status": "closed",
  "trades": [],
  "fees": [],
  "stopPrice": 34997
}

[BitMEXService][POSITION] 獲取 BTC/USD 的持倉信息 - 查詢當前賬戶在該交易對的倉位狀態
[BitMEXService][SYMBOL] 開始轉換交易對: BTC/USD - 原因: 需要將通用符號轉換為 BitMEX 專用格式
[BitMEXService][SYMBOL] 從映射表查找到交易對: BTC/USD -> XBTUSD - 使用預定義映射關係
[BitMEXService][POSITION] 轉換後的交易對: XBTUSD - 確保使用交易所接受的格式
[BitMEXService][POSITION] 調用API獲取持倉數據 - 從交易所實時獲取最新持倉信息
[BitMEXService][POSITION] 獲取到 0 條持倉記錄 - 解析API返回數據
[BitMEXService][POSITION] 未找到任何持倉記錄 - 返回空持倉對象表示無倉位
[持倉信息] 當前持倉：
{
  "symbol": "XBTUSD",
  "size": 0,
  "notional": 0,
  "leverage": 0,
  "entryPrice": 0,
  "markPrice": 0,
  "unrealisedPnl": 0,
  "timestamp": "2025-05-01T10:02:39.200Z"
}

[BitMEXService][BALANCE] 獲取賬戶餘額 - 查詢所有幣種的資金狀況
[BitMEXService][BALANCE] 調用API獲取餘額數據 - 從交易所實時獲取最新資金信息
[BitMEXService][BALANCE] 餘額獲取成功: MAMUSD: 100103.602284, USDT: 99366.166598, BTC: 0.00755968 - 賬戶資金狀況良好
[賬戶餘額] 當前餘額：
{
  "MAMUSD": {
    "free": 100094.52722,
    "used": 9.075064,
    "total": 100103.602284
  },
  "ETH": {
    "free": 0,
    "used": 0,
    "total": 0
  },
  "USDT": {
    "free": 100066.216285,
    "used": -700.049687,
    "total": 99366.166598
  },
  "USDC": {
    "free": 0,
    "used": 0,
    "total": 0
  },
  "SOL": {
    "free": 0,
    "used": 0,
    "total": 0
  },
  "BTC": {
    "free": 1.02507983,
    "used": -1.01752015,
    "total": 0.00755968
  },
  "free": {
    "MAMUSD": 100094.52722,
    "ETH": 0,
    "USDT": 100066.216285,
    "USDC": 0,
    "SOL": 0,
    "BTC": 1.02507983
  },
  "used": {
    "MAMUSD": 9.075064,
    "ETH": 0,
    "USDT": -700.049687,
    "USDC": 0,
    "SOL": 0,
    "BTC": -1.01752015
  },
  "total": {
    "MAMUSD": 100103.602284,
    "ETH": 0,
    "USDT": 99366.166598,
    "USDC": 0,
    "SOL": 0,
    "BTC": 0.00755968
  }
}


[請求完成] 訂單處理完成
